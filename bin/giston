#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.expand_path(File.dirname(__FILE__) + "/../lib"))

begin
  require 'rubygems'
rescue
end
require 'main'

require 'giston'

Home = File.expand_path(ENV['HOME'] || '~')

# mostly blantantly stolen from ara's punch script
# main kicks ass!
Main {
  description <<-txt
    giston is a simple tool to help track changes to svn repositories in git.

    run 'giston help commandname' for more info.
  txt

  examples <<-txt
  txt

  mode(:init){
    description <<-txt
      initialize a new giston mirror

      only adds metadata to the config file, you must manually run "giston fetch mirrorname"

      mirror defaults to the last part of the remote path.
      if trunk is the last part, it is ignored and the previous part is used
    txt

    examples <<-txt
      . giston init svn://remote/path
      . giston init svn://remote/path local/dir
      . giston init svn://remote/path local/dir -r 4
      . giston init svn://remote/path local/dir --revision 13
    txt

    mixin :argument_remote, :optional_mirror, :option_revision

    run{
      Giston::Command.run(:init, remote, mirror, revision)
    }
  }

  mode(:fetch){
    description <<-txt
      fetches files for a new giston mirror from remote svn remote

      only works if local directory does not exist.
      if you actually want to update a mirror, see giston help update
    txt

    examples <<-txt
      . giston fetch local/dir
    txt

    mixin :argument_mirror

    run{
      Giston::Command.run(:fetch, mirror)
    }
  }

  mode(:mirror){
    description <<-txt
      initialize and fetch files for a new giston mirror

      mirror defaults to the last part of the remote path.
      if trunk is the last part, it is ignored and the previous part is used
    txt

    examples <<-txt
      . giston mirror svn://remote/path
      . giston mirror svn://remote/path local/dir
      . giston mirror svn://remote/path local/dir -r 4
      . giston mirror svn://remote/path local/dir --revision 13
    txt

    mixin :argument_remote, :optional_mirror, :option_revision

    run{
      Giston::Command.run(:mirror, remote, mirror, revision)
    }
  }


  mode(:update){
    description 'update a giston mirror, or all mirrors if none specified'

    examples <<-txt
      . giston update
      . giston update local/dir
      . giston update local/dir -r 6000
      . giston update local/dir --revision 6000
    txt

    mixin :optional_mirror, :option_revision

    run{
      Giston::Command.run(:update, mirror, revision)
    }
  }

  mode(:forget){
    description <<-txt
      remove a mirror from giston metadata

      only removes metadata, you must manually remove the local directory
    txt

    examples <<-txt
      . giston forget local/dir
    txt

    mixin :argument_mirror

    run{
      Giston::Command.run(:forget, mirror)
    }
  }

  mode(:version){
    description 'show giston version'

    run{
      puts "giston #{Giston::VERSION::STRING}"
    }
  }

  mixin :argument_mirror do
    argument(:mirror){
      attr
    }
  end

  mixin :optional_mirror do
    argument(:mirror){
      optional
      attr
    }
  end

  mixin :argument_remote do
    argument(:remote){
      attr
    }
  end

  mixin :option_revision do
    option(:revision, :r){
      optional
      argument :required
      desc 'remote svn revision'
      attr
    }
  end

  run{ help! }
}

